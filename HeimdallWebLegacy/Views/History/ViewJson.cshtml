@model HeimdallWeb.DTO.JsonViewPrettyDTO
@{
    ViewData["Title"] = "Resultado do Scan";
}


<head>
    <!-- Prism.js CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2FW0OofqAVdCZiEYkd6dwGXthvkSFWOoGGJgS2CW70VK5dQM5Oh+7ne47s74VTg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

    <div class="container-fluid" data-bs-theme="dark">
        
        <!-- Informações Gerais -->
        <div class="row justify-content-center">
            <div class="col-lg-9" >
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle"></i> Informações do Scan</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Alvo:</dt>
                            <dd class="col-sm-9"><a href="@Model.Alvo" target="_blank" class="text-primary">@Model.Alvo</a></dd>
                            
                            @if (!string.IsNullOrWhiteSpace(Model.Resumo))
                            {
                                <dt class="col-sm-3">Resumo da IA:</dt>
                                <dd class="col-sm-9">@Model.Resumo</dd>
                            }

                            @if (Model.DadosGerais != null)
                            {
                                @if (Model.DadosGerais.StatusCode.HasValue)
                                {
                                    <dt class="col-sm-3">Status HTTP:</dt>
                                    <dd class="col-sm-9"><span class="badge badge-@GetStatusBadge(Model.DadosGerais.StatusCode.Value)">@Model.DadosGerais.StatusCode</span></dd>
                                }
                                @if (!string.IsNullOrWhiteSpace(Model.DadosGerais.Servidor))
                                {
                                    <dt class="col-sm-3">Servidor:</dt>
                                    <dd class="col-sm-9"><code> @Model.DadosGerais.Servidor</code></dd>
                                }
                                @if (Model.DadosGerais.RedirecionamentoHTTPS.HasValue)
                                {
                                    <dt class="col-sm-3">Redireciona HTTPS:</dt>
                                    <dd class="col-sm-9">
                                        @if (Model.DadosGerais.RedirecionamentoHTTPS.Value)
                                        {
                                            <span class="badge badge-success"> Sim</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-warning">Não</span>
                                        }
                                    </dd>
                                }
                                @if (Model.DadosGerais.TotalPortasAbertas.HasValue && Model.DadosGerais.TotalPortasAbertas > 0)
                                {
                                    <dt class="col-sm-3">Portas Abertas:</dt>
                                    <dd class="col-sm-9"><span class="badge badge-danger">@Model.DadosGerais.TotalPortasAbertas</span></dd>
                                }
                                @if (Model.DadosGerais.TotalCaminhosSensiveis.HasValue && Model.DadosGerais.TotalCaminhosSensiveis > 0)
                                {
                                    <dt class="col-sm-3">Caminhos Sensíveis:</dt>
                                    <dd class="col-sm-9"><span class="badge badge-warning">@Model.DadosGerais.TotalCaminhosSensiveis</span></dd>
                                }
                                @if (Model.DadosGerais.TotalCookies.HasValue && Model.DadosGerais.TotalCookies > 0)
                                {
                                    <dt class="col-sm-3">Cookies Detectados:</dt>
                                    <dd class="col-sm-9"><span class="badge badge-info">@Model.DadosGerais.TotalCookies</span></dd>
                                }
                            }
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- SSL/TLS -->
        @if (Model.SSL != null)
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-lock pe-2"></i> SSL/TLS</h3>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-3">Status:</dt>
                                <dd class="col-sm-9">
                                    @if (Model.SSL.Valido)
                                    {
                                        <span class="badge badge-success">Válido</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">Inválido</span>
                                    }
                                </dd>
                                
                                @if (!string.IsNullOrWhiteSpace(Model.SSL.Emissor))
                                {
                                    <dt class="col-sm-3">Emissor:</dt>
                                    <dd class="col-sm-9">@Model.SSL.Emissor</dd>
                                }
                                
                                @if (Model.SSL.DataExpiracao.HasValue)
                                {
                                    <dt class="col-sm-3">Expira em:</dt>
                                    <dd class="col-sm-9">@Model.SSL.DataExpiracao.Value.ToString("dd/MM/yyyy HH:mm")</dd>
                                }
                                
                                @if (Model.SSL.DiasRestantes.HasValue)
                                {
                                    <dt class="col-sm-3">Dias restantes:</dt>
                                    <dd class="col-sm-9">
                                        <span class="badge badge-@GetExpiryBadge(Model.SSL.DiasRestantes.Value)">@Model.SSL.DiasRestantes dias</span>
                                    </dd>
                                }
                                
                                @if (!string.IsNullOrWhiteSpace(Model.SSL.VersaoProtocolo))
                                {
                                    <dt class="col-sm-3">Protocolo:</dt>
                                    <dd class="col-sm-9"><code>@Model.SSL.VersaoProtocolo</code></dd>
                                }
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Headers HTTP -->
        @if (Model.Headers != null && Model.Headers.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-info card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-server pe-2"></i> Headers HTTP (@Model.Headers.Count)</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#headersHttp">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="headersHttp">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Header</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var header in Model.Headers)
                                    {
                                        <tr>
                                            <td style="max-width: 1rem;"><strong>@header.Nome</strong></td>
                                            <td style="max-width: 16rem;"><code>@header.Valor</code></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Security Headers -->
        @if (Model.HeadersSeguranca != null && Model.HeadersSeguranca.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-warning card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-shield-alt pe-2"></i> Security Headers</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#securityHeaders">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="securityHeaders">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Header</th>
                                        <th>Status</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var header in Model.HeadersSeguranca)
                                    {
                                        <tr class="">
                                            <td><strong>@header.Nome</strong></td>
                                            <td>
                                                @if (header.Status == "Presente")
                                                {
                                                    <span class="badge badge-success">Presente</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-warning">Ausente</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(header.Valor))
                                                {
                                                    <code class="text-sm">@header.Valor</code>
                                                }
                                                else
                                                {
                                                    <em class="text-muted">N/A</em>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Portas Abertas -->
        @if (Model.Portas != null && Model.Portas.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-danger card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-door-open pe-2"></i> Portas Abertas (@Model.Portas.Count)</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#portasAbertas">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="portasAbertas">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>IP</th>
                                        <th style="width: 10%">Porta</th>
                                        <th style="width: 15%">Serviço</th>
                                        <th style="width: 15%">Severidade</th>
                                        <th>Descrição</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var porta in Model.Portas)
                                    {
                                        <tr class="">
                                            <td><code>@porta.IP</code></td>
                                            <td><strong>@porta.Porta</strong></td>
                                            <td>@porta.Servico</td>
                                            <td>
                                                <span class="">
                                                    @porta.Severidade
                                                </span>
                                            </td>
                                            <td>@porta.Descricao</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Caminhos Sensíveis -->
        @if (Model.CaminhosTestados != null && Model.CaminhosTestados.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-warning card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-folder-open pe-2"></i> Caminhos Sensíveis Encontrados (@Model.CaminhosTestados.Count)</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#caminhosSensiveis">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="caminhosSensiveis">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Caminho</th>
                                        <th style="width: 15%">Status</th>
                                        <th style="width: 20%">Resultado</th>
                                        <th>Evidência</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var path in Model.CaminhosTestados)
                                    {
                                        <tr>
                                            <td><code>@path.Caminho</code></td>
                                            <td><span class="">@path.StatusCode</span></td>
                                            <td>@path.Resultado</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(path.Evidencia))
                                                {
                                                    <small>@path.Evidencia</small>
                                                }
                                                else
                                                {
                                                    <em class="text-muted">-</em>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Cookies -->
        @if (Model.Cookies != null && Model.Cookies.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-info card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-cookie-bite pe-2"></i> Cookies Detectados (@Model.Cookies.Count)</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#cookiesDetectados">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="cookiesDetectados">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th style="width: 10%">Secure</th>
                                        <th style="width: 10%">HttpOnly</th>
                                        <th style="width: 12%">SameSite</th>
                                        <th style="width: 12%">Risco</th>
                                        <th>Observações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cookie in Model.Cookies)
                                    {
                                        <tr class="">
                                            <td><strong>@cookie.Nome</strong></td>
                                            <td>
                                                @if (cookie.TemSecure)
                                                {
                                                    <i class="fas fa-check text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times text-danger"></i>
                                                }
                                            </td>
                                            <td>
                                                @if (cookie.TemHttpOnly)
                                                {
                                                    <i class="fas fa-check text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times text-danger"></i>
                                                }
                                            </td>
                                            <td><small>@cookie.SameSite</small></td>
                                            <td><span class="">@cookie.Risco</span></td>
                                            <td><small>@cookie.Descricao</small></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- HTTP Redirects -->
        @if (Model.HttpRedirects != null && Model.HttpRedirects.Any())
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-secondary card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-exchange-alt pe-2"></i> Análise de HTTP Redirects (@Model.HttpRedirects.Count IPs testados)</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#httpRedirects">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0 collapse" id="httpRedirects">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 15%">IP</th>
                                        <th style="width: 12%">Porta 80</th>
                                        <th style="width: 12%">Redirect</th>
                                        <th>URL Destino</th>
                                        <th style="width: 15%">Avaliação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var redirect in Model.HttpRedirects)
                                    {
                                        <tr>
                                            <td><code>@redirect.IP</code></td>
                                            <td>
                                                @if (redirect.PortaAberta)
                                                {
                                                    <span class="badge badge-success">Aberta</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-secondary">Fechada</span>
                                                }
                                            </td>
                                            <td>
                                                @if (redirect.RedirectDetectado)
                                                {
                                                    <text><i class="fas fa-check text-success"></i> Sim</text>
                                                }
                                                else
                                                {
                                                    <text><i class="fas fa-times text-muted"></i> Não</text>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(redirect.RedirectUrl))
                                                {
                                                    <small><code>@redirect.RedirectUrl</code></small>
                                                }
                                                else
                                                {
                                                    <em class="text-muted">-</em>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(redirect.Descricao))
                                                {
                                                    <small>@redirect.Descricao</small>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Robots.txt -->
        @if (Model.Robots != null && Model.Robots.Encontrado)
        {
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="card card-secondary card-outline">
                        <div class="card-header d-flex justify-content-between">
                            <h3 class="card-title"><i class="fas fa-robot pe-2"></i> robots.txt</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#robotsTxt">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body collapse" id="robotsTxt">
                            <dl class="row">
                                <dt class="col-sm-3">Status:</dt>
                                <dd class="col-sm-9"><span class="badge badge-success">Encontrado</span></dd>
                                
                                @if (Model.Robots.SitemapEncontrado && !string.IsNullOrWhiteSpace(Model.Robots.SitemapUrl))
                                {
                                    <dt class="col-sm-3">Sitemap:</dt>
                                    <dd class="col-sm-9"><a href="@Model.Robots.SitemapUrl" target="_blank" class="text-info">@Model.Robots.SitemapUrl</a></dd>
                                }
                            </dl>

                            @if (Model.Robots.Alertas != null && Model.Robots.Alertas.Any())
                            {
                                <hr />
                                <h5><i class="fas fa-exclamation-triangle"></i> Análise de Segurança</h5>
                                <div class="list-group">
                                    @foreach (var alerta in Model.Robots.Alertas)
                                    {
                                        <div class="list-group-item list-group-item-action flex-column align-items-start">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">
                                                    <span class="">@alerta.Severidade</span>
                                                </h6>
                                            </div>
                                            <p class="mb-1">@alerta.Mensagem</p>
                                        </div>
                                    }
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(Model.Robots.Conteudo))
                            {
                                <hr />
                                <p><strong>Conteúdo:</strong></p>
                                <pre class="bg-light p-2" style="max-height: 300px; overflow-y: auto;"><code>@Model.Robots.Conteudo</code></pre>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- JSON Completo com Syntax Highlighting -->
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card card-dark card-outline">
                    <div class="card-header d-flex justify-content-between">
                        <h3 class="card-title"><i class="fas fa-code pe-2"></i> JSON Completo</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" onclick="downloadJsonFile()">
                                <i class="fas fa-download"></i> Baixar
                            </button>
                            <button type="button" class="btn btn-tool" onclick="copyJsonToClipboard()">
                                <i class="fas fa-copy"></i> Copiar
                            </button>
                            <button type="button" class="btn btn-tool" data-bs-toggle="collapse" data-bs-target="#jsonCompleto">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0 collapse show" id="jsonCompleto">
                        <pre class="m-0" style="max-height: 600px; overflow-y: auto;"><code class="language-json" id="jsonCode">@Model.JsonCompleto</code></pre>
                    </div>
                </div>
            </div>
        </div>

    </div>

@section Scripts {
    <!-- Prism.js Core + JSON Language -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" integrity="sha512-nsJE9udvILGCEOjb3JrqRvW2+UmPP9x0C3/A0tpLGv+MyFvKzXKD8nGViIYN6WPx7xIBqXg77Xpn/OGQzQ6LQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        // Função para copiar JSON para clipboard
        function copyJsonToClipboard() {
            const jsonText = document.getElementById('jsonCode').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                toastr.success('JSON copiado para a área de transferência!');
            }).catch(err => {
                toastr.error('Erro ao copiar JSON.');
                console.error('Erro ao copiar: ', err);
            });
        }

        // Função para baixar JSON como arquivo
        function downloadJsonFile() {
            try {
                const jsonText = document.getElementById('jsonCode').textContent;
                const alvo = '@Model.Alvo';
                const dataAtual = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const nomeArquivo = `scan-${alvo.replace(/[^a-z0-9]/gi, '_')}-${dataAtual}.json`;
                
                // Criar blob com o JSON
                const blob = new Blob([jsonText], { type: 'application/json' });
                
                // Criar link temporário para download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                
                // Adicionar ao DOM, clicar e remover
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpar URL criada
                URL.revokeObjectURL(link.href);
                
                toastr.success('JSON baixado com sucesso!');
            } catch (err) {
                toastr.error('Erro ao baixar JSON.');
                console.error('Erro ao baixar: ', err);
            }
        }

        // Melhorar funcionalidade dos botões de collapse
        $(document).ready(function() {
            // Alternar ícone quando colapsar/expandir
            $('[data-bs-toggle="collapse"]').on('click', function() {
                const icon = $(this).find('i');
                setTimeout(() => {
                    const target = $(this).data('bs-target');
                    const isCollapsed = $(target).hasClass('show');
                    icon.toggleClass('fa-minus fa-plus');
                }, 350); // Aguarda animação do Bootstrap
            });
        });
    </script>
}

@functions {
    private string GetStatusBadge(int statusCode)
    {
        if (statusCode >= 200 && statusCode < 300) return "success";
        if (statusCode >= 300 && statusCode < 400) return "info";
        if (statusCode >= 400 && statusCode < 500) return "warning";
        if (statusCode >= 500) return "danger";
        return "secondary";
    }

    private string GetExpiryBadge(int dias)
    {
        if (dias < 30) return "danger";
        if (dias < 90) return "warning";
        return "success";
    }

    private string GetRiskBadge(string risco)
    {
        return risco?.ToLower() switch
        {
            "critico" or "crítico" => "danger",
            "alto" => "warning",
            "medio" or "médio" => "info",
            "baixo" => "secondary",
            "informativo" => "light",
            _ => "secondary"
        };
    }

    private string GetCookieRowClass(string risco)
    {
        return risco?.ToLower() switch
        {
            "critico" or "crítico" => "table-danger",
            "alto" => "table-warning",
            _ => ""
        };
    }

    private string GetPortRowClass(string severidade)
    {
        return severidade?.ToLower() switch
        {
            "critico" or "crítico" => "table-danger",
            "alto" => "table-warning",
            "medio" or "médio" => "table-info",
            _ => ""
        };
    }
}
